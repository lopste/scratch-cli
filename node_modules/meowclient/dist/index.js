import w from"cross-fetch";var i="Mozilla/5.0";import{parse as A}from"node-html-parser";var S=class{constructor({username:t,session:e}){this.user=t,this.session=e}async getStatus(){return A(await this.getUserHTML()).querySelector(".group").innerHTML.trim()}async deleteComment(t){let e=await w(`https://scratch.mit.edu/site-api/comments/user/${this.user}/del/`,{method:"POST",body:JSON.stringify({id:t.toString()}),headers:{"x-csrftoken":this.session.csrfToken,"X-Token":this.session.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.cookieSet,referer:`https://scratch.mit.edu/users/${this.user}`,"User-Agent":i}});if(!e.ok)throw console.log(e.status,await e.text()),new Error("Error deleting comment.");return e}async getUserHTML(){if(typeof this.scratchUserHTML!="string"){let t=await w(`https://scratch.mit.edu/users/${this.user}`);if(!t.ok)throw new Error("Cannot find user.");this.scratchUserHTML=await t.text()}return this.scratchUserHTML}async getUserAPI(){if(typeof this.scratchUserAPI>"u"){let t=await w(`https://api.scratch.mit.edu/users/${this.user}`);if(!t.ok)throw new Error("Cannot find user.");this.scratchUserAPI=await t.json()}return this.scratchUserAPI}async getComments(t=1){let e=await w(`https://scratch.mit.edu/site-api/comments/user/${this.user}/?page=${t}`);if(!e.ok){if(t==1)throw new Error("! Error in fetching comments");return[]}let s=await e.text(),r=A(s).querySelectorAll(".top-level-reply"),n=[];for(let g in r){let a=r[g];if(typeof a=="function")break;let p=a.querySelector(".comment").id,f=a.querySelector(".comment").getElementsByTagName("a")[0].getAttribute("data-comment-user"),b=a.querySelector(".comment").querySelector(".info").querySelector(".content").innerHTML.trim(),C=[],P=a.querySelector(".replies").querySelectorAll(".reply");for(let H in P){let l=P[H];if(l.tagName==="A"||typeof l=="function"||typeof l=="number")continue;let $=l.querySelector(".comment").id,L=l.querySelector(".comment").getElementsByTagName("a")[0].getAttribute("data-comment-user"),M=l.querySelector(".comment").querySelector(".info").querySelector(".content").textContent.trim().replace(/\n+/gm,"").replace(/\s+/gm," ");C.push({id:$,username:L,content:M,apiID:$.substring(9)})}n.push({id:p,username:f,content:b,apiID:p.substring(9),replies:C})}if(n.length==0)throw new Error("No comments found.");return n}};import u from"cross-fetch";import{WebSocket as X}from"ws";import D from"events";var x=class extends D.EventEmitter{constructor({id:t,session:e,server:s="wss://clouddata.scratch.mit.edu"}){super();this.open=!1;this.queue=[];this.variables={};this.disconnected=!1;this.id=t,this.session=e,this.server=s,this.connect()}connect(){this.open=!1,this.connection=new X(this.server,{headers:{Cookie:this.session.cookieSet,Origin:"https://scratch.mit.edu"}}),this.connection.on("message",t=>{if(!!t)for(let e of t.toString().split(`
`)){let s=JSON.parse(e||'{"method": "err"}');s.method=="set"&&(this.emit("set",{name:s.name,value:s.value}),this.variables[s.name]=s.value)}}),this.connection.on("open",()=>{this.open=!0,this.send({method:"handshake",user:this.session.sessionJSON.user.username,project_id:this.id.toString()}),this.emit("connect",null);for(let t of this.queue)this.send(t)}),this.connection.on("error",t=>{throw this.emit("error",t),t}),this.connection.on("close",()=>{this.disconnected||(this.emit("reconnect",null),this.connect())})}send(t){this.emit("internal-send",t),this.connection.send(`${JSON.stringify(t)}
`)}setVariable(t,e){let s=t.startsWith("\u2601 ")?t.substring(2):t;if(this.variables[`\u2601 ${s}`]=e,!this.open){this.queue.push({user:this.session.sessionJSON.user.username,method:"set",name:`\u2601 ${s}`,value:e.toString(),project_id:this.id});return}this.send({user:this.session.sessionJSON.user.username,method:"set",name:`\u2601 ${s}`,value:e.toString(),project_id:this.id})}getVariable(t){let e=t.startsWith("\u2601 ")?t.substring(2):t;return this.variables[`\u2601 ${e}`]}close(){this.emit("close",null),this.disconnected=!0,this.connection.close()}},j=x;var E=class{constructor({id:t,session:e}){this.id=t,this.session=e}async getAPIData(){if(typeof this.scratchProjectAPI>"u"){let t=await u(`https://api.scratch.mit.edu/projects/${this.id}`,{headers:{"User-Agent":i}});if(!t.ok)throw new Error("Cannot find project.");this.scratchProjectAPI=await t.json()}return this.scratchProjectAPI}async getComments(t=0,e=20){let s=await this.getAPIData(),o=await u(`https://api.scratch.mit.edu/users/${s.author.username}/projects/${this.id}/comments?offset=${t}&limit=${e}`,{headers:{"User-Agent":i}});if(!o.ok)throw new Error(`Comments returned status ${o.status} - ${o.statusText}`);return await o.json()}async getCommentReplies(t=0,e=20,s){let o=await this.getAPIData(),r=await u(`https://api.scratch.mit.edu/users/${o.author.username}/projects/${this.id}/comments/${s}/replies?offset=${t}&limit=${e}`,{headers:{"User-Agent":i}});if(!r.ok)throw new Error(`Comments returned status ${r.status} - ${r.statusText}`);return await r.json()}async setTitle(t){let e=await u(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({title:t}),headers:{"x-csrftoken":this.session.csrfToken,"X-Token":this.session.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting title. ${e.status}`);this.scratchProjectAPI=void 0}async setInstructions(t){let e=await u(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({instructions:t}),headers:{"x-csrftoken":this.session.csrfToken,"X-Token":this.session.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting instructions. ${e.status}`);this.scratchProjectAPI=void 0}async setNotesAndCredits(t){let e=await u(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({description:t}),headers:{"x-csrftoken":this.session.csrfToken,"X-Token":this.session.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting Notes and Credits. ${e.status}`);this.scratchProjectAPI=void 0}async unshare(){let t=await u(`https://scratch.mit.edu/site-api/projects/all/${this.id}/`,{method:"PUT",body:JSON.stringify({isPublished:!1}),headers:{"x-csrftoken":this.session.csrfToken,"X-Token":this.session.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.cookieSet,referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw new Error(`Error in unsharing. ${t.status}`)}async share(){let t=await u(`https://api.scratch.mit.edu/proxy/projects/${this.id}/share/`,{method:"PUT",headers:{"X-CSRFToken":this.session.csrfToken,"X-Token":this.session.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.cookieSet,Referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,Accept:"application/json","Content-Type":"application/json","Content-Length":"0",Origin:"https://scratch.mit.edu",Host:"api.scratch.mit.edu","Cache-Control":"max-age=0, no-cache",Pragma:"no-cache","Accept-Encoding":"gzip, deflate, br"}});if(!t.ok)throw new Error(`Error in sharing. ${t.status}`)}createCloudConnection(){return new j({id:this.id,session:this.session})}},U=E;import c from"cross-fetch";var O=class{constructor({id:t,session:e}){this.id=t,this.session=e}async getAPIData(){if(typeof this.scratchStudioAPI>"u"){let t=await c(`https://api.scratch.mit.edu/studios/${this.id}/`,{headers:{"User-Agent":i}});this.scratchStudioAPI=await t.json()}return this.scratchStudioAPI}async setTitle(t){let e=await c(`https://scratch.mit.edu/site-api/galleries/all/${this.id}/`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.csrfToken,Cookie:this.session.cookieSet},body:JSON.stringify({title:t})});if(!e.ok)throw new Error(`Could not set title - ${e.statusText}`);return e}async setDescription(t){let e=await c(`https://scratch.mit.edu/site-api/galleries/all/${this.id}/`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.csrfToken,Cookie:this.session.cookieSet},body:JSON.stringify({description:t})});if(!e.ok)throw new Error(`Could not set description - ${e.statusText}`);return e}async inviteCurator(t){let e=await c(`https://scratch.mit.edu/site-api/users/curators-in/${this.id}/invite_curator/?usernames=${t}`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.csrfToken,Cookie:this.session.cookieSet}});if(!e.ok)throw new Error(`Could not invite curator - ${e.statusText}`);return e}async removeCurator(t){let e=await c(`https://scratch.mit.edu/site-api/users/curators-in/${this.id}/remove/?usernames=${t}`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.csrfToken,Cookie:this.session.cookieSet}});if(!e.ok)throw new Error(`Could not remove curator - ${e.statusText}`);return e}async addProject(t){let e=await c(`https://api.scratch.mit.edu/studios/${this.id}/project/${t}`,{method:"POST",headers:{"User-Agent":i,"X-Token":this.session.sessionJSON.user.token}});if(!e.ok)throw new Error(`Could not add project - ${e.statusText}`);return e}async removeProject(t){let e=await c(`https://api.scratch.mit.edu/studios/${this.id}/project/${t}`,{method:"DELETE",headers:{"User-Agent":i,"X-Token":this.session.sessionJSON.user.token}});if(!e.ok)throw new Error(`Could not remove project - ${e.statusText}`);return e}async getCurators(t=24,e=0){let s=await c(`https://api.scratch.mit.edu/studios/${this.id}/curators/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get curators - ${s.statusText}`);return await s.json()}async getManagers(t=24,e=0){let s=await c(`https://api.scratch.mit.edu/studios/${this.id}/managers/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get managers - ${s.statusText}`);return await s.json()}async getProjects(t=24,e=0){let s=await c(`https://api.scratch.mit.edu/studios/${this.id}/projects/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get projects - ${s.statusText}`);return await s.json()}},R=O;import I from"cross-fetch";import{parse as B}from"node-html-parser";import z from"cross-fetch";var q=class{constructor({id:t,session:e,content:s,parsableContent:o,author:r,time:n}){this.id=t,this.session=e,this.content=s,this.author=r,this.parsableContent=o,this.time=n}async edit(t){let e=await z(`https://scratch.mit.edu/discuss/post/${this.id}/edit/`,{headers:{Cookie:this.session.cookieSet,"User-Agent":i,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Host:"scratch.mit.edu",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/post/${this.id}/edit/`},method:"POST",body:`csrfmiddlewaretoken=${this.session.csrfToken}&body=${encodeURIComponent(t).replace("%20","+").replace(`
`,`\r
`)}`});if(!e.ok)throw new Error(`Error editing post ${this.id} - ${e.statusText}`);return e}},N=q;import k from"cross-fetch";var v=class{constructor({id:t,session:e,sticky:s,title:o,replyCount:r}){this.id=t,this.session=e,this.sticky=s,this.title=o,this.replyCount=r}async getPosts(){let t=[],e=await k(`https://scratch.mit.edu/discuss/m/topic/${this.id}`,{headers:{"User-Agent":i}});if(!e.ok)throw new Error(`Error fetching posts for topic ${this.id} - ${e.statusText}`);return B(await e.text()).querySelector(".content").getElementsByTagName("article").forEach(r=>{let n=r.getAttribute("id").split("-")[1],g=r.querySelector(".post-content").innerHTML,a=r.querySelector(".post-content"),p=new Date(r.querySelector("time").getAttribute("datetime")),f=new N({id:Number(n),session:this.session,content:g,time:p,parsableContent:a,author:r.getElementsByTagName("header")[0].getElementsByTagName("h1")[0].innerText});t.push(f)}),t}async follow(){let t=await k(`https://scratch.mit.edu/discuss/subscription/topic/${this.id}/add/`,{method:"POST",headers:{Cookie:this.session.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.csrfToken,"Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Host:"scratch.mit.edu",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/topic/${this.id}/`}});if(!t.ok)throw new Error(`Error following topic ${this.id} - ${t.statusText}`);return t}async unfollow(){let t=await k(`https://scratch.mit.edu/discuss/subscription/topic/${this.id}/delete/`,{method:"POST",headers:{Cookie:this.session.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.csrfToken,"Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Host:"scratch.mit.edu",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/topic/${this.id}/`}});if(!t.ok)throw new Error(`Error unfollowing topic ${this.id} - ${t.statusText}`);return t}},y=v;import{parse as W}from"node-html-parser";var _=class{constructor({id:t,session:e}){this.id=t,this.session=e}async getTopics(){let t=[],e=await I(`https://scratch.mit.edu/discuss/m/${this.id}`,{headers:{"User-Agent":i}});if(!e.ok)throw new Error(`Error fetching topics for forum ${this.id} - ${e.statusText}`);return W(await e.text()).querySelector(".topic.list").getElementsByTagName("li").forEach(n=>{let g=n.getElementsByTagName("a")[0].getAttribute("href").split("/").splice(1)[3],a=n.querySelector("strong").innerText,p=Number(n.querySelector(".item span").innerText.split(" ")[0]),f=n.classList.contains("sticky"),b=new y({id:Number(g),title:a,replyCount:p,sticky:f,session:this.session});t.push(b)}),t}getTopic(t){return new y({id:t,session:this.session})}async setSignature(t){let e=await I(`https://scratch.mit.edu/discuss/settings/${this.session.sessionJSON.user.username}/`,{headers:{Cookie:this.session.cookieSet,"User-Agent":i,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Host:"scratch.mit.edu",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/settings/${this.session.sessionJSON.user.username}/`},method:"POST",body:`csrfmiddlewaretoken=${this.session.csrfToken}&signature=${encodeURIComponent(t).replace("%20","+").replace(`
`,`\r
`)}&update=`});if(!e.ok)throw new Error(`Error editing signature - ${e.statusText}`);return e}},F=_;import T from"cross-fetch";var J=class{async init(t,e){this.username=t;let s={"x-csrftoken":"a","x-requested-with":"XMLHttpRequest",Cookie:"scratchcsrftoken=a;scratchlanguage=en;",referer:"https://scratch.mit.edu","User-Agent":i},o=await T("https://scratch.mit.edu/login/",{method:"POST",body:JSON.stringify({username:t,password:e}),headers:s});if(!o.ok)throw new Error("Login failed.");this.csrfToken=/scratchcsrftoken=(.*?);/gm.exec(o.headers.get("set-cookie"))[1],this.token=/"(.*)"/gm.exec(o.headers.get("set-cookie"))[1],this.cookieSet="scratchcsrftoken="+this.csrfToken+";scratchlanguage=en;scratchsessionsid="+this.token+";";let r=await T("https://scratch.mit.edu/session",{method:"GET",headers:{Cookie:this.cookieSet,"User-Agent":i,Referer:"https://scratch.mit.edu/",Host:"scratch.mit.edu","Cache-Control":"max-age=0, no-cache","X-Requested-With":"XMLHttpRequest",Pragma:"no-cache",Accept:"*/*","Accept-Encoding":"gzip, deflate, br"}});this.sessionJSON=await r.json()}getProfile(t){return new S({username:t,session:this})}getProject(t){return new U({id:t,session:this})}getStudio(t){return new R({id:t,session:this})}getForum(t){return new F({id:t,session:this})}async logout(){if(!this.csrfToken||!this.token)return;let t=await T("https://scratch.mit.edu/accounts/logout/",{method:"POST",body:`csrfmiddlewaretoken=${this.csrfToken}`,headers:{Cookie:this.cookieSet,"User-Agent":i,accept:"application/json",Referer:"https://scratch.mit.edu/",Origin:"https://scratch.mit.edu",Host:"scratch.mit.edu","Content-Type":"application/x-www-form-urlencoded",Accept:"*/*","Accept-Encoding":"gzip, deflate, br"}});if(!t.ok)throw new Error(`Error in logging out. ${t.status}`)}},V=J;export{V as ScratchSession};
